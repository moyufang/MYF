# USART

发送器特性
- 在数据传输期间不能复位TE位，否则将破坏TX脚上的数据，因为波特率计数器停止计数。
- TE位被激活后将发送一个空闲帧，空闲帧包括校验位（如果有）和停止位。
- 通过向 TDR 写数据来执行一次发送。
接收器特性
- 在接收数据时，RE位不应该被复位。如果RE位在接收时被清零，当前字节的接收被丢失。
- 空闲状态检测到下降沿后，接收器会判断起始位是否有噪声，有的话设置 NE 位，判断标准见手册
- 当接收到一个断开帧时，USART像处理帧错误一样处理它。
- 当一空闲帧被检测到时，其处理步骤和接收到普通数据帧一样，但如果IDLEIE位被设置将产生一个中断。
- 在多缓冲器通信时，RXNE在每个字节接收后被置起，并由DMA对数据寄存器的读操作而清零。
- 在单缓冲器模式里，由软件读USART_DR寄存器完成对RXNE位清除，必须在下一个字符接受前被清零，以免溢出错误。
- 对字节中的每个位也会进行噪声检测，不通过时产生错误帧

stm32 的 USART 有多种模式
![[USART_mode.png]]

USART 有多种模式，虽然各模式配置、使用方式不同，但有一些是共通的。

- 状态寄存器(USART_SR) —— 与接受器相关的位
	- PE：校验错误，可产生 PEI 中断
	- FE：帧错误，当检测到同步错位，过多的噪声或者检测到断开符，该位被硬件置位，由软件清零。不会产生中断，但和 RXNE 一起出现，硬件会产生 RXNEI 中断。在多缓冲区通信模式下，如果设置了EIE位，则设置NE标志时会产生中断
	- NE: 噪声错误。中断机制同 FE
	- ORE：过载错误，RXNE 为 1 时接收器却要向 RDR 写入新接受的数据时发生 ORE，但 RDR 的值不会丢失，新数据会丢失，同时产生 RXNEI 中断
	- IDLE：当检测到接受总线空闲时，该位被硬件置位，会产生 IDLEI 中断，由软件序列以特殊步骤清除该位(先读USART_SR，然后读USART_DR)
	- RXNE：数据寄存器 RDR 非空标志，会产生 RXNEI 中断。
- 状态寄存器(USART_SR) —— 与发送器相关的位
	- TC：发送完成，会产生 TCI 中断，由软件序列以特殊步骤清除该位(先读USART_SR，然后读USART_DR)
	- TXE：发送数据寄存器空，当 TDR 的数据转移到移位寄存器后，由硬件置位，会产生 TXEI 中断，对 USART_DR 执行写操作该位将清零。
- 数据寄存器(USART_DR)
	- DR：9位，由两个寄存器 RDR 和 TDR 组成，写 DR 时会写 TDR，读 DR 时会读 RDR。当启动校验，写入 DR 时，校验位会被硬件计算并替代，读 DR 的校验位时读到的是接受到的校验位
- 波特比率寄存器(USART_BRR)
	- DIV_Mantissa：USARTDIV的整数部分
	- DIV_Fraction：USARTDIV的小数部分
- 控制寄存器 1(USART_CR1)
	- SBK：发送断开帧，有软件置位，硬件复位
	- RE：接受使能
	- TE：发送使能
	- IDLEIE：IDLE 中断使能
	- RXNEIE：RXNE 中断使能
	- TCIE：TC 中断使能
	- TXEIE：TXE 中断使能
	- PEIE：PE 中断使能
	- PS：校验位选择，0 偶校验，1 奇校验
	- PCE：是否使用校验
	- M：字长，置 0 代表 “1 个起始位 + 8 个数据位 + n 个停止位"，置 1 则增加 1 个数据位
	- UE：USART 使能
- 控制寄存器 2(USART_CR2)
	- STOP：停止位，00,01,10,11 分别代表 1,0.5,2,1.5 个停止位
### 异步模式

一般的 USART 异步模式。

### 硬件流控制模式

在 RX, TX 基础上多了 CTS 和 RTS，用于防止接受溢出，发送方探查到 CTS 为低时表示接受方已做好接受准备，接受方设置 RTS 来通知接收方自己是否做好接受准备
### DMA模式

DMA 发送、接受模式。

- 控制寄存器 3(USART_CR3)
	- DMAT：DMA 发送使能
	- DMAR：DMA 接受使能
### 多处理通信模式

单一主 USART 发送，多从 USART 接受，通常有地址标识符，一次发送中仅相应从 USART 会进行接受。
### 同步模式

除了 TX，RX，还加入了 CK，故能够支持更高波特率，通信更稳定。
### 智能卡模式

一种半双工、基于特定协议 (ISO/IEC 7816-3) 的工作模式，专用于连接 SIM 卡或金融智能卡。
### 半双工模式

单线双工模式。
### IrDA 红外模式

红外发送、接受模式。

### LIN 局域互联网模式

LIN 是一种低成本、单线、低速串行通信总线协议，主要用于汽车电子中的车身控制（如车窗、座椅、灯光、雨刮、传感器等）以及其他对成本敏感、速率要求不高的分布式系统。


   